(function(){var b=adf.mf.api.amx.TypeHandler.register(adf.mf.api.amx.AmxTag.NAMESPACE_AMX,"fragment");b.prototype.createChildrenNodes=function(b){var a=b.getAttribute("src");void 0===a?b.setState(null==b.getAttributeExpression("src")?adf.mf.api.amx.AmxNodeStates.UNRENDERED:adf.mf.api.amx.AmxNodeStates.INITIAL):null==a?b.setState(adf.mf.api.amx.AmxNodeStates.UNRENDERED):(b.setAttributeResolvedValue("_fragmentState",{rendered:!1,placeholderRendered:!1,childrenCreated:!1,fragmentLoading:!1,waitingOnEl:b.getState()==
adf.mf.api.amx.AmxNodeStates.WAITING_ON_EL_EVALUATION}),this._createChildrenFromFragment(b));return!0};b.prototype.updateChildren=function(c,a){var e=c.getAttribute("_fragmentState");if(a.hasChanged("src")&&e.childrenCreated)return adf.mf.api.amx.AmxNodeChangeResult.REPLACE;if(a.hasChanged("_fragmentLoaded")&&(delete e.updateArguments,e.childrenCreated&&!e.placeholderRendered))return adf.mf.log.AMX.isLoggable(adf.mf.log.level.FINEST)&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","updateChildren",
"Update children called due to attribute _fragmentLoaded, but the fragment has already been rendered. Node: "+c.getId()),adf.mf.api.amx.AmxNodeChangeResult.NONE;a.hasChanged("_facetsToBeCreated")&&this._createFacets(c,c.isRendered());if(c.getState()==adf.mf.api.amx.AmxNodeStates.WAITING_ON_EL_EVALUATION){e.waitingOnEl=!0;if(e.placeholderRendered&&null!=document.getElementById(c.getId()))return c.setState(adf.mf.api.amx.AmxNodeStates.PARTIALLY_RENDERED),adf.mf.api.amx.AmxNodeChangeResult.NONE;c.setState(adf.mf.api.amx.AmxNodeStates.ABLE_TO_RENDER);
return adf.mf.api.amx.AmxNodeChangeResult.REFRESH}var d=e.waitingOnEl=!1,e=c.getAttribute("_fragmentState");e.childrenCreated||e.waitingOnEl||e.fragmentLoading||this._createChildrenFromFragment(c)&&(d=!0);e=b.superclass.updateChildren.call(this,c,a);return Math.max(adf.mf.api.amx.AmxNodeChangeResult[d?"REFRESH":"NONE"],e)};b.prototype.render=function(b){var a=b.getAttribute("_fragmentState"),e=document.createElement("div");a.waitingOnEl||0==a.childrenCreated?(e.className="amx-deferred-loading",b.setState(adf.mf.api.amx.AmxNodeStates.PARTIALLY_RENDERED),
a.placeholderRendered=!0):this._renderChildren(b,e);return e};b.prototype.refresh=function(c,a,e){var d=c.getAttribute("_fragmentState");if(!d.waitingOnEl&&0!=d.childrenCreated){var g=document.getElementById(c.getId());d.childrenCreated&&(d.placeholderRendered&&(d.placeholderRendered=!1,g.classList.remove("amx-deferred-loading")),d.rendered||this._renderChildren(c,g));b.superclass.refresh.call(this,c,a,e)}};b.prototype.visitChildren=function(b,a,e){var d=this._getFragmentUri(b),g=!1;null==this._fragmentStack?
(this._fragmentStack=[d],g=!0):this._fragmentStack.push(d);try{if(b.visitStampedChildren(null,null,null,a,e))return!0}finally{g?delete this._fragmentStack:this._fragmentStack.pop()}d=b.getAttribute("_facetVisitData");if(null!=d)for(var g=0,h=d.length;g<h;++g){var k=d[g],m=k.name,n=k.attributes,k=k.key;this._setupFacetContext(n);try{if(b.visitStampedChildren(k,[m],null,a,e))return!0}finally{this._tearDownFacetContext(n)}}return!1};b.prototype.__removeFacet=function(b,a){var e=a.getAttribute("facetName"),
d=b.getAttribute("_facetVisitData"),g=a.getId(),e=b.getChildren(e,g);if(0<e.length)for(var h=e.length-1;0<=h;--h){if(b.removeChild(e[h])||this._removePendingFacetRefCreation(b,a),null!=d)for(var k=0,m=d.length;k<m;++k)if(d[k].key==g){d.splice(k,1);break}}else this._removePendingFacetRefCreation(b,a)};b.prototype._renderChildren=function(b,a){for(var e=b.renderDescendants(),d=0,g=e.length;d<g;++d)a.appendChild(e[d]);e=b.getAttribute("_fragmentState");e.placeholderRendered=!1;e.rendered=!0;b.setState(adf.mf.api.amx.AmxNodeStates.RENDERED)};
b.prototype._removePendingFacetRefCreation=function(b,a){var e=b.getAttribute("_facetsToBeCreated");if(null!=e)for(var d=0,g=e.length;d<g;++d)a===e[d]&&(e.splice(d,1),--g,--d)};b.prototype._setupFacetContext=function(b){if(null!=b)for(var a=0,e=b.length;a<e;++a){var d=b[a];adf.mf.api.pushVariable(d.name,d.value)}};b.prototype._tearDownFacetContext=function(b){if(null!=b)for(var a=0,e=b.length;a<e;++a)adf.mf.api.popVariable(b[a].name)};b.prototype._getFragmentUri=function(b){var a=b.getAttribute("_uri");
if(null==a&&(a=b.getAttribute("src"),null!=a))if(null==this._fragmentStack||"/"==a[0])a=adf.mf.api.amx.buildRelativePath(a);else{var e=this._fragmentStack[this._fragmentStack.length-1],d=e.lastIndexOf("/");0<=d&&(a=e.substring(0,d)+"/"+a)}b.setAttributeResolvedValue("_uri",a);return a};b.prototype._isInfiniteLoop=function(b,a){var e=this._fragmentStack;if(e)if(adf.mf.environment.profile.dtMode){if(0<=e.indexOf(a))return b.setState(adf.mf.api.amx.AmxNodeStates.UNRENDERED),!0}else if(e.length>=(adf.mf.api.amx.fragmentRecursionLimit||
25)&&0<=e.indexOf(a))return b.setState(adf.mf.api.amx.AmxNodeStates.UNRENDERED),adf.mf.internal.amx.errorHandlerImpl(null,Error(adf.mf.resource.getInfoString("AMXErrorBundle","ERROR_FRAGMENT_RECURSIVE_LOOP"))),adf.mf.log.logInfoResource("AMXInfoBundle",adf.mf.log.level.SEVERE,"fragmentHandler.prototype._createChildrenFromFragment","amx_fragment_RECURSION",a),adf.mf.log.Framework.isLoggable(adf.mf.log.level.FINE)&&adf.mf.log.Framework.logp(adf.mf.log.level.FINE,"amx:fragment","_isInfiniteLoop","Found infinite loop with AMX node "+
b.getId()),!0;return!1};b.prototype._createChildrenFromFragment=function(b){var a=this._getFragmentUri(b),e=b.getAttribute("_fragmentState");if(null==a)b.setState(adf.mf.api.amx.AmxNodeStates.UNRENDERED),e.waitingOnEl=!1,e.childrenCreated=!0;else{if(this._isInfiniteLoop(b,a))return e.waitingOnEl=!1,e.childrenCreated=!0;var d=adf.mf.log.AMX.isLoggable(adf.mf.log.level.FINEST);d&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_createChildrenFromFragment","Requesting the fragment tag for AMX node '"+
b.getId()+"' and URI: "+a);var g=adf.mf.internal.amx.__getAmxTagForPage(a,!0);if(null!=g)return d&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_createChildrenFromFragment","Fragment was cached. Calling _handleLoadedFragment (URI: "+a+", AmxNode: "+b.getId()+")"),e.fragmentLoading=!1,a=e.updateArguments,null!=a&&(a.cancel(),delete e.updateArguments),this._handleLoadedFragment(b,g),!0;d&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_createChildrenFromFragment","Waiting on the fragment file to load and the tags to be built (URI: "+
a+", AmxNode: "+b.getId()+")");e.fragmentLoading||(e.fragmentLoading=!0,this._loadFragment(b,a));return!1}};b.prototype._handleLoadedFragment=function(b,a){var e=adf.mf.log.AMX.isLoggable(adf.mf.log.level.FINEST);b.getState()==adf.mf.api.amx.AmxNodeStates.WAITING_ON_EL_EVALUATION?(e&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_handleLoadedFragment","Node is waiting on EL: "+b.getId()),b.setState(adf.mf.api.amx.AmxNodeStates.ABLE_TO_RENDER)):(e&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,
"amx:fragment","_handleLoadedFragment","Fragment tag promise callback invoked for node: "+b.getId()),e=a.buildAmxNode(b,null),b.addChild(e),adf.mf.log.AMX.isLoggable(adf.mf.log.level.FINEST)&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_fragmentLoaded","Children created. Node: "+b.getId()),b.getAttribute("_fragmentState").childrenCreated=!0)};b.prototype._loadFragment=function(b,a){var e=adf.mf.log.AMX.isLoggable(adf.mf.log.level.FINEST);adf.mf.api.amx.showLoadingIndicator();adf.mf.internal.amx.__getAmxTagForPage(a,
!1).then(function(){try{var a=b.getAttribute("_fragmentState");if(a.fragmentLoading){e&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_loadFragment","The fragment tag promise was fulfilled. Calling markNodeForUpdate for node: "+b.getId());a.fragmentLoading=!1;var g=new adf.mf.internal.amx.AmxNodeUpdateArguments;g.setAffectedAttribute(b,"_fragmentLoaded");a.updateArguments=g;adf.mf.api.amx.markNodeForUpdate(g)}else e&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_loadFragment",
"The fragment tag promise has completed, but the state is no longer loading. The markNodeForUpdate method will not be invoked for node: "+b.getId())}finally{adf.mf.api.amx.hideLoadingIndicator()}},function(d,e){adf.mf.log.logInfoResource("AMXInfoBundle",adf.mf.log.level.SEVERE,"amx:fragment._loadFragment",a);adf.mf.log.Framework.isLoggable(adf.mf.log.level.FINE)&&adf.mf.log.Framework.logp(adf.mf.log.level.FINE,"amx:fragment","_loadFragment","Failed to load file for fragment "+b.getId()+" request: "+
d+" response: "+e);e instanceof Error&&adf.mf.internal.amx.errorHandlerImpl(null,e);var h=b.getAttribute("_fragmentState");h.waitingOnEl=!1;h.childrenCreated=!0;b.setState(adf.mf.api.amx.AmxNodeStates.UNRENDERED);adf.mf.api.amx.hideLoadingIndicator()});b.setState(adf.mf.api.amx.AmxNodeStates.ABLE_TO_RENDER)};b.prototype._createFacets=function(b,a){var e=adf.mf.log.AMX.isLoggable(adf.mf.log.level.FINEST);e&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_createFacets","Creating the facets for "+
b.getId());var d=b.getAttribute("_facetsToBeCreated");b.setAttributeResolvedValue("_facetsToBeCreated",null);var g=b.getAttribute("_facetVisitData");null==g&&(g=[],b.setAttributeResolvedValue("_facetVisitData",g));var h=a?new adf.mf.internal.amx.AmxNodeUpdateArguments:null;e&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_createFacets","Number of facets to be created: "+d.length);for(var k=0,m=d.length;k<m;++k){var n=d[k],t=n.getAttribute("facetName"),u=n.getId();g.push({key:u,name:t,
attributes:n.getAttribute("_attributeData")});for(var t=b.createStampedChildren(u,[t]),u=0,v=t.length;u<v;++u)t[u].__setRenderingParent(n);a&&0<t.length&&h.setAffectedAttribute(n,"_facetCreated");n.setState(adf.mf.api.amx.AmxNodeStates.ABLE_TO_RENDER)}a&&0<h.getAffectedNodes().length&&(e&&adf.mf.log.AMX.logp(adf.mf.log.level.FINEST,"amx:fragment","_createFacets","The fragment was already rendered, calling markNodeForUpdate to update the UI with the facets"),adf.mf.api.amx.markNodeForUpdate(h))}})();